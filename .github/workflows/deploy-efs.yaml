name: deploy-efs

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©
  push:               # íŠ¹ì • íŒŒì¼ ë³€ê²½ ì‹œ ìë™ ì‹¤í–‰
    paths:
      - 'efs/**'
      - '.github/workflows/deploy-efs.yaml'

jobs:
  efs-setup:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ap-northeast-2                    # AWS ë¦¬ì „ ì„¤ì •
      EKS_CLUSTER_NAME: petclinic-cluster           # ì‹¤ì œ EKS í´ëŸ¬ìŠ¤í„° ì´ë¦„
      VPC_STACK_NAME: vpc-3tier-stack               # ì‹¤ì œ VPC ìŠ¤íƒ ì´ë¦„

    steps:
      # 1. GitHub ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. AWS ìê²© ì¦ëª… êµ¬ì„± (GitHub Secrets ì‚¬ìš©)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 3. kubectl CLI ì„¤ì¹˜
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      # 4. EKS í´ëŸ¬ìŠ¤í„°ì™€ ì—°ê²°ì„ ìœ„í•œ kubeconfig êµ¬ì„±
      - name: Configure kubeconfig for EKS
        run: |
          aws eks update-kubeconfig \
            --region $AWS_REGION \
            --name $EKS_CLUSTER_NAME

      # 5. CloudFormation ìŠ¤íƒì—ì„œ SubnetId, SecurityGroupId ì¶”ì¶œ
      - name: Get VPC Stack Outputs (subnet, security group)
      # ğŸ” ë””ë²„ê¹…: subnet_id, sg_id ì¶œë ¥ í™•ì¸
      - name: Debug VPC Outputs
        run: |
          echo "ğŸ‘‰ Subnet ID: ${{ steps.vpc.outputs.subnet_id }}"
          echo "ğŸ‘‰ Security Group ID: ${{ steps.vpc.outputs.sg_id }}"
        id: vpc
        run: |
          subnet_id=$(aws cloudformation describe-stacks \
            --stack-name $VPC_STACK_NAME \
            --query "Stacks[0].Outputs[?OutputKey=='SubnetId'].OutputValue" \
            --output text)

          sg_id=$(aws cloudformation describe-stacks \
            --stack-name $VPC_STACK_NAME \
            --query "Stacks[0].Outputs[?OutputKey=='SecurityGroupId'].OutputValue" \
            --output text)

          echo "subnet_id=$subnet_id" >> $GITHUB_OUTPUT
          echo "sg_id=$sg_id" >> $GITHUB_OUTPUT

      # 6. EFS íŒŒì¼ ì‹œìŠ¤í…œ ìƒì„±
      - name: Create EFS File System
        id: efs
        run: |
          fs_id=$(aws efs create-file-system \
            --region $AWS_REGION \
            --tags Key=Name,Value=petclinic-efs \
            --query "FileSystemId" \
            --output text)

          echo "fs_id=$fs_id" >> $GITHUB_OUTPUT
          echo "EFS FileSystem ID: $fs_id"

      # 7. EFS ìƒíƒœ ìˆ˜ë™ ëŒ€ê¸° (available ë  ë•Œê¹Œì§€ ë°˜ë³µ í™•ì¸)
      - name: Wait for EFS to be available
        run: |
          fs_id=${{ steps.efs.outputs.fs_id }}
          while true; do
            status=$(aws efs describe-file-systems \
              --file-system-id $fs_id \
              --query "FileSystems[0].LifeCycleState" \
              --output text)

            echo "Current EFS state: $status"

            if [ "$status" == "available" ]; then
              echo "âœ… EFS is now available."
              break
            fi

            echo "â³ Waiting for EFS to become available..."
            sleep 5
          done

      # 8. ë§ˆìš´íŠ¸ íƒ€ê²Ÿ ìƒì„± (subnet ë° security group ì—°ê²°)
      - name: Create EFS Mount Target
        run: |
          aws efs create-mount-target \
            --file-system-id ${{ steps.efs.outputs.fs_id }} \
            --subnet-id ${{ steps.vpc.outputs.subnet_id }} \
            --security-groups ${{ steps.vpc.outputs.sg_id }}

      # 9. Helm values.yaml íŒŒì¼ì— volumeHandleì— EFS ID ì‚½ì…
      - name: Update Helm values.yaml (inject EFS volumeHandle)
        run: |
          efs_id=${{ steps.efs.outputs.fs_id }}
          sed -i "s|volumeHandle:.*|volumeHandle: ${efs_id}|" efs/values.yaml

      # 10. StorageClass, PV, PVC ë¦¬ì†ŒìŠ¤ë¥¼ ì¿ ë²„ë„¤í‹°ìŠ¤ì— ì ìš©
      - name: Apply EFS StorageClass, PV, PVC
        run: |
          kubectl apply -f efs/storageclass.yaml
          kubectl apply -f efs/pv.yaml
          kubectl apply -f efs/pvc.yaml
