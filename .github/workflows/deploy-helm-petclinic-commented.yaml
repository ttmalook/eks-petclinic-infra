# GitHub Actions Workflow: Helm Chart ê¸°ë°˜ PetClinic ì•± ìë™ ë°°í¬ with EFS ì—°ë™
# ì´ ì›Œí¬í”Œë¡œëŠ” charts/petclinic/ ë””ë ‰í† ë¦¬ ë³€ê²½ ì‹œ ìë™ ì‹¤í–‰ë˜ë©°, ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.
# ì£¼ìš” ì‘ì—…:
# - EKS í´ëŸ¬ìŠ¤í„° ì ‘ê·¼ ì„¤ì •
# - EFS ID ë™ì ìœ¼ë¡œ ì¡°íšŒ
# - Helm Chart ë°°í¬ ì‹œ EFS volumeHandle ìë™ ì£¼ì…

name: Deploy PetClinic via Helm

on:
  # Helm Chart ë³€ê²½ ì‹œ ìë™ ì‹¤í–‰
  push:
    paths:
      - 'charts/petclinic/**'
  # GitHub UIì—ì„œ ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©
  workflow_dispatch:

jobs:
  helm-deploy:
    # GitHub Actions ê¸°ë³¸ Linux í™˜ê²½ì—ì„œ ì‹¤í–‰
    runs-on: ubuntu-latest

    steps:
    # ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: Checkout repository
      uses: actions/checkout@v3

    # AWS ìê²© ì¦ëª… êµ¬ì„± (Secretsì— ë“±ë¡ëœ ê°’ ì‚¬ìš©)
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-2

    # kubectl ì„¤ì¹˜
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: v1.27.1

    # Helm ì„¤ì¹˜
    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: v3.12.0

    # EKS í´ëŸ¬ìŠ¤í„° kubeconfig ì„¤ì •
    - name: Configure kubeconfig for EKS
      run: |
        aws eks --region ap-northeast-2 update-kubeconfig --name petclinic

    # Helm ë°°í¬: EFS ID ì¡°íšŒ í›„ Helmì— ë™ì  ì£¼ì…
    - name: Deploy PetClinic via Helm with dynamic EFS
      run: |
        kubectl create namespace petclinic --dry-run=client -o yaml | kubectl apply -f -

        EFS_ID=$(aws efs describe-file-systems \
          --query "FileSystems[?contains(Name, 'petclinic')].FileSystemId | [0]" \
          --region ap-northeast-2 --output text)

        echo "ğŸ“¦ Using EFS volumeHandle: $EFS_ID"

        helm upgrade --install petclinic ./charts/petclinic \
          -n petclinic \
          --set storage.volumeHandle=$EFS_ID
